# GFramework.Game

> æ¸¸æˆç‰¹å®šåŠŸèƒ½æŠ½è±¡ - ä¸ºæ¸¸æˆå¼€å‘æä¾›ä¸“é—¨çš„å·¥å…·å’Œç³»ç»Ÿ

GFramework.Game æ˜¯ GFramework æ¡†æ¶çš„æ¸¸æˆç‰¹å®šåŠŸèƒ½æ¨¡å—ï¼Œæä¾›äº†æ¸¸æˆå¼€å‘ä¸­å¸¸ç”¨çš„æŠ½è±¡å’Œå·¥å…·ï¼ŒåŒ…æ‹¬èµ„äº§ç®¡ç†ã€å­˜å‚¨ç³»ç»Ÿã€åºåˆ—åŒ–ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [æ¶æ„æ¨¡å—ç³»ç»Ÿ](#æ¶æ„æ¨¡å—ç³»ç»Ÿ)
- [èµ„äº§ç®¡ç†](#èµ„äº§ç®¡ç†)
- [å­˜å‚¨ç³»ç»Ÿ](#å­˜å‚¨ç³»ç»Ÿ)
- [åºåˆ—åŒ–ç³»ç»Ÿ](#åºåˆ—åŒ–ç³»ç»Ÿ)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [æ€§èƒ½ç‰¹æ€§](#æ€§èƒ½ç‰¹æ€§)

## æ¦‚è¿°

GFramework.Game ä¸ºæ¸¸æˆå¼€å‘æä¾›äº†ä¸“é—¨çš„åŠŸèƒ½æ¨¡å—ï¼Œä¸ GFramework.Core çš„å¹³å°æ— å…³ç‰¹æ€§å®Œç¾ç»“åˆï¼Œä¸ºæ¸¸æˆé¡¹ç›®æä¾›äº†ä¸€æ•´å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

- **æ¸¸æˆå¯¼å‘**ï¼šä¸“é—¨é’ˆå¯¹æ¸¸æˆå¼€å‘åœºæ™¯è®¾è®¡
- **æ¨¡å—åŒ–æ¶æ„**ï¼šå¯æ’æ‹”çš„æ¨¡å—ç³»ç»Ÿï¼ŒæŒ‰éœ€ç»„åˆ
- **æ•°æ®æŒä¹…åŒ–**ï¼šå®Œå–„çš„å­˜æ¡£å’Œæ•°æ®ç®¡ç†æ–¹æ¡ˆ
- **èµ„æºç®¡ç†**ï¼šé«˜æ•ˆçš„èµ„æºåŠ è½½å’Œç®¡ç†æœºåˆ¶

## æ ¸å¿ƒç‰¹æ€§

### ğŸ—ï¸ æ¨¡å—åŒ–æ¶æ„

- **AbstractModule**ï¼šå¯é‡ç”¨çš„æ¶æ„æ¨¡å—åŸºç±»
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šä¸æ¡†æ¶ç”Ÿå‘½å‘¨æœŸæ·±åº¦é›†æˆ
- **ä¾èµ–æ³¨å…¥**ï¼šæ¨¡å—é—´çš„ä¾èµ–è‡ªåŠ¨ç®¡ç†
- **é…ç½®é©±åŠ¨**ï¼šçµæ´»çš„æ¨¡å—é…ç½®ç³»ç»Ÿ

### ğŸ“¦ èµ„äº§ç®¡ç†

- **ç»Ÿä¸€èµ„æºç›®å½•**ï¼šé›†ä¸­åŒ–çš„èµ„æºæ³¨å†Œå’ŒæŸ¥è¯¢
- **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥å’Œæ³›å‹æ”¯æŒ
- **é‡å¤æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹èµ„æºé‡å¤æ³¨å†Œ
- **æ˜ å°„æ”¯æŒ**ï¼šçµæ´»çš„èµ„æºæ˜ å°„å’Œåˆ«åç³»ç»Ÿ

### ğŸ’¾ å­˜å‚¨ç³»ç»Ÿ

- **åˆ†å±‚å­˜å‚¨**ï¼šå‘½åç©ºé—´æ”¯æŒçš„å­˜å‚¨éš”ç¦»
- **å¤šæ ¼å¼æ”¯æŒ**ï¼šJSONã€äºŒè¿›åˆ¶ç­‰å¤šç§å­˜å‚¨æ ¼å¼
- **å¼‚æ­¥æ“ä½œ**ï¼šå®Œæ•´çš„å¼‚æ­¥å­˜å‚¨ API
- **ç‰ˆæœ¬å…¼å®¹**ï¼šå­˜æ¡£ç‰ˆæœ¬ç®¡ç†å’Œè¿ç§»æ”¯æŒ

### ğŸ”„ åºåˆ—åŒ–ç³»ç»Ÿ

- **JSON é›†æˆ**ï¼šåŸºäº Newtonsoft.Json çš„åºåˆ—åŒ–
- **è‡ªå®šä¹‰åºåˆ—åŒ–**ï¼šæ”¯æŒè‡ªå®šä¹‰åºåˆ—åŒ–é€»è¾‘
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåºåˆ—åŒ–ç¼“å­˜å’Œä¼˜åŒ–ç­–ç•¥
- **ç±»å‹å®‰å…¨**ï¼šå¼ºç±»å‹çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–

## æ¶æ„æ¨¡å—ç³»ç»Ÿ

### AbstractModule åŸºç¡€ä½¿ç”¨

```csharp
using GFramework.Game.architecture;

public class AudioModule : AbstractModule
{
    public override void Install(IArchitecture architecture)
    {
        // æ³¨å†ŒéŸ³é¢‘ç›¸å…³ç³»ç»Ÿ
        architecture.RegisterSystem(new AudioSystem());
        architecture.RegisterSystem(new MusicSystem());
        
        // æ³¨å†ŒéŸ³é¢‘å·¥å…·
        architecture.RegisterUtility(new AudioUtility());
        architecture.RegisterUtility(new MusicUtility());
    }
    
    public override void OnPhase(ArchitecturePhase phase, IArchitecture architecture)
    {
        switch (phase)
        {
            case ArchitecturePhase.BeforeModelInit:
                // åœ¨æ¨¡å‹åˆå§‹åŒ–å‰å‡†å¤‡éŸ³é¢‘èµ„æº
                PreloadAudioResources();
                break;
                
            case ArchitecturePhase.Ready:
                // æ¶æ„å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹æ’­æ”¾èƒŒæ™¯éŸ³ä¹
                StartBackgroundMusic();
                break;
                
            case ArchitecturePhase.Destroying:
                // æ¸…ç†éŸ³é¢‘èµ„æº
                CleanupAudioResources();
                break;
        }
    }
    
    private void PreloadAudioResources()
    {
        // é¢„åŠ è½½éŸ³é¢‘èµ„æº
        var audioUtility = architecture.GetUtility<AudioUtility>();
        audioUtility.PreloadAudio("background_music");
        audioUtility.PreloadAudio("shoot_sound");
        audioUtility.PreloadAudio("explosion_sound");
    }
    
    private void StartBackgroundMusic()
    {
        var musicSystem = architecture.GetSystem<MusicSystem>();
        musicSystem.PlayBackgroundMusic("background_music");
    }
    
    private void CleanupAudioResources()
    {
        var audioUtility = architecture.GetUtility<AudioUtility>();
        audioUtility.UnloadAllAudio();
    }
}
```

### å¤æ‚æ¨¡å—ç¤ºä¾‹

```csharp
public class SaveModule : AbstractModule
{
    private ISaveSystem _saveSystem;
    private IDataMigrationManager _migrationManager;
    
    public override void Install(IArchitecture architecture)
    {
        // æ³¨å†Œå­˜å‚¨ç›¸å…³ç»„ä»¶
        _saveSystem = new SaveSystem();
        architecture.RegisterUtility(_saveSystem);
        
        _migrationManager = new DataMigrationManager();
        architecture.RegisterUtility(_migrationManager);
        
        // æ³¨å†Œæ•°æ®ç‰ˆæœ¬ç®¡ç†
        architecture.RegisterSystem(new SaveDataVersionSystem());
    }
    
    public override void OnPhase(ArchitecturePhase phase, IArchitecture architecture)
    {
        switch (phase)
        {
            case ArchitecturePhase.AfterModelInit:
                // åœ¨æ¨¡å‹åˆå§‹åŒ–åè®¾ç½®æ•°æ®è¿ç§»
                SetupDataMigrations();
                break;
                
            case ArchitecturePhase.Ready:
                // å°è¯•è‡ªåŠ¨åŠ è½½å­˜æ¡£
                TryAutoLoadSave();
                break;
        }
    }
    
    private void SetupDataMigrations()
    {
        // è®¾ç½®æ•°æ®ç‰ˆæœ¬è¿ç§»
        _migrationManager.RegisterMigration<PlayerData>(1, 2, MigratePlayerDataV1ToV2);
        _migrationManager.RegisterMigration<PlayerData>(2, 3, MigratePlayerDataV2ToV3);
    }
    
    private void TryAutoLoadSave()
    {
        if (_saveSystem.HasAutoSave())
        {
            _saveSystem.LoadAutoSave();
        }
    }
    
    private PlayerData MigratePlayerDataV1ToV2(PlayerData v1Data)
    {
        return new PlayerData
        {
            // è¿ç§»é€»è¾‘
            Name = v1Data.Name,
            Health = v1Data.Health,
            // æ–°å¢å­—æ®µ
            MaxHealth = 100,
            Level = 1
        };
    }
    
    private PlayerData MigratePlayerDataV2ToV3(PlayerData v2Data)
    {
        return new PlayerData
        {
            // è¿ç§»é€»è¾‘
            Name = v2Data.Name,
            Health = v2Data.Health,
            MaxHealth = v2Data.MaxHealth,
            Level = v2Data.Level,
            // æ–°å¢å­—æ®µ
            Experience = 0,
            Skills = new List<SkillData>()
        };
    }
}
```

### æ¨¡å—é…ç½®

```csharp
public class ModuleConfig
{
    public string SaveDirectory { get; set; } = "saves";
    public int AutoSaveInterval { get; set; } = 300; // 5åˆ†é’Ÿ
    public bool EnableDataCompression { get; set; } = true;
    public int MaxSaveSlots { get; set; } = 10;
}

public class ConfigurableSaveModule : AbstractModule
{
    private ModuleConfig _config;
    
    public ConfigurableSaveModule(ModuleConfig config)
    {
        _config = config;
    }
    
    public override void Install(IArchitecture architecture)
    {
        var saveSystem = new SaveSystem(_config);
        architecture.RegisterUtility(saveSystem);
        
        // é…ç½®è‡ªåŠ¨ä¿å­˜
        if (_config.AutoSaveInterval > 0)
        {
            architecture.RegisterSystem(new AutoSaveSystem(_config.AutoSaveInterval));
        }
    }
}
```

## èµ„äº§ç®¡ç†

### AbstractAssetCatalogUtility åŸºç¡€ä½¿ç”¨

```csharp
using GFramework.Game.assets;

public class GameAssetCatalog : AbstractAssetCatalogUtility
{
    public override void Initialize()
    {
        base.Initialize();
        
        // æ³¨å†Œåœºæ™¯èµ„äº§
        RegisterSceneUnit("Player", "res://scenes/Player.tscn");
        RegisterSceneUnit("Enemy", "res://scenes/Enemy.tscn");
        RegisterSceneUnit("Bullet", "res://scenes/Bullet.tscn");
        
        // æ³¨å†Œåœºæ™¯é¡µé¢
        RegisterScenePage("MainMenu", "res://ui/MainMenu.tscn");
        RegisterScenePage("GameUI", "res://ui/GameUI.tscn");
        RegisterScenePage("PauseMenu", "res://ui/PauseMenu.tscn");
        
        // æ³¨å†Œé€šç”¨èµ„äº§
        RegisterAsset<Texture2D>("PlayerTexture", "res://textures/player.png");
        RegisterAsset<Texture2D>("EnemyTexture", "res://textures/enemy.png");
        RegisterAsset<AudioStream>("ShootSound", "res://audio/shoot.wav");
        RegisterAsset<AudioStream>("ExplosionSound", "res://audio/explosion.wav");
    }
    
    // è‡ªå®šä¹‰èµ„äº§éªŒè¯
    protected override bool ValidateAsset(string key, string path)
    {
        if (!FileAccess.FileExists(path))
        {
            GD.PrintErr($"Asset file not found: {path}");
            return false;
        }
        
        return true;
    }
    
    // èµ„äº§åŠ è½½å®Œæˆå›è°ƒ
    protected override void OnAssetLoaded(string key, object asset)
    {
        GD.Print($"Asset loaded: {key}");
        
        // å¯¹ç‰¹å®šèµ„äº§è¿›è¡Œé¢å¤–å¤„ç†
        if (key == "PlayerTexture")
        {
            var texture = (Texture2D)asset;
            // é¢„å¤„ç†çº¹ç†...
        }
    }
}
```

### èµ„äº§æ˜ å°„ç³»ç»Ÿ

```csharp
public class AssetMapping
{
    public string Key { get; set; }
    public string Path { get; set; }
    public Type Type { get; set; }
    public Dictionary<string, object> Metadata { get; set; } = new();
}

public class AdvancedAssetCatalog : AbstractAssetCatalogUtility
{
    public override void Initialize()
    {
        base.Initialize();
        
        // ä½¿ç”¨æ˜ å°„å¯¹è±¡æ³¨å†Œèµ„äº§
        RegisterAsset(new AssetMapping
        {
            Key = "Player",
            Path = "res://scenes/Player.tscn",
            Type = typeof(PackedScene),
            Metadata = new Dictionary<string, object>
            {
                ["category"] = "character",
                ["tags"] = new[] { "player", "hero", "controlled" },
                ["health"] = 100,
                ["speed"] = 5.0f
            }
        });
        
        // æ‰¹é‡æ³¨å†Œ
        RegisterAssetsFromDirectory("res://textures/", "*.png", "texture");
        RegisterAssetsFromDirectory("res://audio/", "*.wav", "sound");
    }
    
    private void RegisterAssetsFromDirectory(string directory, string pattern, string prefix)
    {
        var dir = DirAccess.Open(directory);
        if (dir == null) return;
        
        dir.ListDirBegin();
        var fileName = dir.GetNext();
        
        while (!string.IsNullOrEmpty(fileName))
        {
            if (fileName.EndsWith(pattern.Substring(1)))
            {
                var key = $"{prefix}{Path.GetFileNameWithoutExtension(fileName)}";
                var path = Path.Combine(directory, fileName);
                
                RegisterAsset(key, path);
            }
            
            fileName = dir.GetNext();
        }
        
        dir.ListDirEnd();
    }
}
```

### èµ„äº§å·¥å‚æ¨¡å¼

```csharp
public interface IAssetFactory<T>
{
    T Create(string key);
    bool CanCreate(string key);
}

public class PlayerFactory : IAssetFactory<Player>
{
    private readonly AbstractAssetCatalogUtility _catalog;
    
    public PlayerFactory(AbstractAssetCatalogUtility catalog)
    {
        _catalog = catalog;
    }
    
    public Player Create(string key)
    {
        var scene = _catalog.GetScene<PackedScene>(key);
        var player = scene.Instantiate<Player>();
        
        // é…ç½®ç©å®¶
        player.Health = GetPlayerHealth(key);
        player.Speed = GetPlayerSpeed(key);
        
        return player;
    }
    
    public bool CanCreate(string key)
    {
        return _catalog.HasScene(key) && key.StartsWith("Player");
    }
    
    private int GetPlayerHealth(string key)
    {
        var metadata = _catalog.GetAssetMetadata(key);
        return metadata?.GetValueOrDefault("health", 100) ?? 100;
    }
    
    private float GetPlayerSpeed(string key)
    {
        var metadata = _catalog.GetAssetMetadata(key);
        return metadata?.GetValueOrDefault("speed", 5.0f) ?? 5.0f;
    }
}
```

## å­˜å‚¨ç³»ç»Ÿ

### ScopedStorage åˆ†å±‚å­˜å‚¨

```csharp
using GFramework.Game.storage;

public class GameDataManager
{
    private readonly IStorage _rootStorage;
    private readonly IStorage _playerStorage;
    private readonly IStorage _saveStorage;
    
    public GameDataManager(IStorage rootStorage)
    {
        _rootStorage = rootStorage;
        
        // åˆ›å»ºåˆ†å±‚å­˜å‚¨
        _playerStorage = new ScopedStorage(rootStorage, "player");
        _saveStorage = new ScopedStorage(rootStorage, "saves");
    }
    
    public void SavePlayerData(string playerId, PlayerData data)
    {
        _playerStorage.Write($"{playerId}/profile", data);
        _playerStorage.Write($"{playerId}/inventory", data.Inventory);
        _playerStorage.Write($"{playerId}/stats", data.Stats);
    }
    
    public PlayerData LoadPlayerData(string playerId)
    {
        var profile = _playerStorage.Read<PlayerProfile>($"{playerId}/profile");
        var inventory = _playerStorage.Read<Inventory>($"{playerId}/inventory", new Inventory());
        var stats = _playerStorage.Read<PlayerStats>($"{playerId}/stats", new PlayerStats());
        
        return new PlayerData
        {
            Profile = profile,
            Inventory = inventory,
            Stats = stats
        };
    }
    
    public void SaveGame(int slotId, SaveData data)
    {
        _saveStorage.Write($"slot_{slotId}", data);
        _saveStorage.Write($"slot_{slotId}/timestamp", DateTime.Now);
        _saveStorage.Write($"slot_{slotId}/version", data.Version);
    }
    
    public SaveData LoadGame(int slotId)
    {
        return _saveStorage.Read<SaveData>($"slot_{slotId}");
    }
    
    public List<SaveSlotInfo> GetSaveSlotInfos()
    {
        var infos = new List<SaveSlotInfo>();
        
        for (int i = 1; i <= 10; i++)
        {
            var timestamp = _saveStorage.Read<DateTime>($"slot_{i}/timestamp");
            var version = _saveStorage.Read<int>($"slot_{i}/version");
            
            if (timestamp != default)
            {
                infos.Add(new SaveSlotInfo
                {
                    SlotId = i,
                    Timestamp = timestamp,
                    Version = version
                });
            }
        }
        
        return infos;
    }
}
```

### è‡ªå®šä¹‰å­˜å‚¨å®ç°

```csharp
public class EncryptedStorage : IStorage
{
    private readonly IStorage _innerStorage;
    private readonly IEncryptor _encryptor;
    
    public EncryptedStorage(IStorage innerStorage, IEncryptor encryptor)
    {
        _innerStorage = innerStorage;
        _encryptor = encryptor;
    }
    
    public void Write<T>(string key, T data)
    {
        var json = JsonConvert.SerializeObject(data);
        var encrypted = _encryptor.Encrypt(json);
        _innerStorage.Write(key, encrypted);
    }
    
    public T Read<T>(string key, T defaultValue = default)
    {
        var encrypted = _innerStorage.Read<string>(key);
        if (string.IsNullOrEmpty(encrypted))
            return defaultValue;
            
        var json = _encryptor.Decrypt(encrypted);
        return JsonConvert.DeserializeObject<T>(json);
    }
    
    public async Task WriteAsync<T>(string key, T data)
    {
        var json = JsonConvert.SerializeObject(data);
        var encrypted = _encryptor.Encrypt(json);
        await _innerStorage.WriteAsync(key, encrypted);
    }
    
    public async Task<T> ReadAsync<T>(string key, T defaultValue = default)
    {
        var encrypted = await _innerStorage.ReadAsync<string>(key);
        if (string.IsNullOrEmpty(encrypted))
            return defaultValue;
            
        var json = _encryptor.Decrypt(encrypted);
        return JsonConvert.DeserializeObject<T>(json);
    }
    
    public bool Has(string key)
    {
        return _innerStorage.Has(key);
    }
    
    public void Delete(string key)
    {
        _innerStorage.Delete(key);
    }
    
    public void Clear()
    {
        _innerStorage.Clear();
    }
}
```

### å­˜å‚¨ç¼“å­˜å±‚

```csharp
public class CachedStorage : IStorage
{
    private readonly IStorage _innerStorage;
    private readonly Dictionary<string, object> _cache;
    private readonly Dictionary<string, DateTime> _cacheTimestamps;
    private readonly TimeSpan _cacheExpiry;
    
    public CachedStorage(IStorage innerStorage, TimeSpan cacheExpiry = default)
    {
        _innerStorage = innerStorage;
        _cacheExpiry = cacheExpiry == default ? TimeSpan.FromMinutes(5) : cacheExpiry;
        _cache = new Dictionary<string, object>();
        _cacheTimestamps = new Dictionary<string, DateTime>();
    }
    
    public T Read<T>(string key, T defaultValue = default)
    {
        if (_cache.TryGetValue(key, out var cachedValue) && 
            !IsCacheExpired(key))
        {
            return (T)cachedValue;
        }
        
        var value = _innerStorage.Read<T>(key, defaultValue);
        UpdateCache(key, value);
        
        return value;
    }
    
    public void Write<T>(string key, T data)
    {
        _innerStorage.Write(key, data);
        UpdateCache(key, data);
    }
    
    public async Task<T> ReadAsync<T>(string key, T defaultValue = default)
    {
        if (_cache.TryGetValue(key, out var cachedValue) && 
            !IsCacheExpired(key))
        {
            return (T)cachedValue;
        }
        
        var value = await _innerStorage.ReadAsync<T>(key, defaultValue);
        UpdateCache(key, value);
        
        return value;
    }
    
    public async Task WriteAsync<T>(string key, T data)
    {
        await _innerStorage.WriteAsync(key, data);
        UpdateCache(key, data);
    }
    
    public bool Has(string key)
    {
        return _cache.ContainsKey(key) || _innerStorage.Has(key);
    }
    
    public void Delete(string key)
    {
        _cache.Remove(key);
        _cacheTimestamps.Remove(key);
        _innerStorage.Delete(key);
    }
    
    public void Clear()
    {
        _cache.Clear();
        _cacheTimestamps.Clear();
        _innerStorage.Clear();
    }
    
    public void ClearCache()
    {
        _cache.Clear();
        _cacheTimestamps.Clear();
    }
    
    private bool IsCacheExpired(string key)
    {
        if (!_cacheTimestamps.TryGetValue(key, out var timestamp))
            return true;
            
        return DateTime.Now - timestamp > _cacheExpiry;
    }
    
    private void UpdateCache<T>(string key, T value)
    {
        _cache[key] = value;
        _cacheTimestamps[key] = DateTime.Now;
    }
}
```

## åºåˆ—åŒ–ç³»ç»Ÿ

### JsonSerializer ä½¿ç”¨

```csharp
using GFramework.Game.serializer;

public class GameDataSerializer
{
    private readonly JsonSerializer _serializer;
    
    public GameDataSerializer()
    {
        _serializer = new JsonSerializer(new JsonSerializerSettings
        {
            Formatting = Formatting.Indented,
            NullValueHandling = NullValueHandling.Ignore,
            DefaultValueHandling = DefaultValueHandling.Populate,
            TypeNameHandling = TypeNameHandling.Auto
        });
        
        // è‡ªå®šä¹‰è½¬æ¢å™¨
        _serializer.Converters.Add(new Vector2JsonConverter());
        _serializer.Converters.Add(new ColorJsonConverter());
        _serializer.Converters.Add(new GodotResourceJsonConverter());
    }
    
    public string Serialize<T>(T data)
    {
        return _serializer.Serialize(data);
    }
    
    public T Deserialize<T>(string json)
    {
        return _serializer.Deserialize<T>(json);
    }
    
    public void SerializeToFile<T>(string path, T data)
    {
        var json = Serialize(data);
        FileAccess.Open(path, FileAccess.ModeFlags.Write).StoreString(json);
    }
    
    public T DeserializeFromFile<T>(string path)
    {
        if (!FileAccess.FileExists(path))
            return default(T);
            
        var file = FileAccess.Open(path, FileAccess.ModeFlags.Read);
        var json = file.GetAsText();
        file.Close();
        
        return Deserialize<T>(json);
    }
}
```

### è‡ªå®šä¹‰ JSON è½¬æ¢å™¨

```csharp
public class Vector2JsonConverter : JsonConverter<Vector2>
{
    public override void WriteJson(JsonWriter writer, Vector2 value, JsonSerializer serializer)
    {
        writer.WriteStartObject();
        writer.WritePropertyName("x");
        writer.WriteValue(value.X);
        writer.WritePropertyName("y");
        writer.WriteValue(value.Y);
        writer.WriteEndObject();
    }
    
    public override Vector2 ReadJson(JsonReader reader, Type objectType, Vector2 existingValue, bool hasExistingValue, JsonSerializer serializer)
    {
        if (reader.TokenType == JsonToken.Null)
            return Vector2.Zero;
            
        var obj = serializer.Deserialize<Dictionary<string, float>>(reader);
        return new Vector2(obj["x"], obj["y"]);
    }
}

public class ColorJsonConverter : JsonConverter<Color>
{
    public override void WriteJson(JsonWriter writer, Color value, JsonSerializer serializer)
    {
        writer.WriteValue(value.ToHtml());
    }
    
    public override Color ReadJson(JsonReader reader, Type objectType, Color existingValue, bool hasExistingValue, JsonSerializer serializer)
    {
        if (reader.TokenType == JsonToken.Null)
            return Colors.White;
            
        var html = reader.Value.ToString();
        return Color.FromHtml(html);
    }
}

public class GodotResourceJsonConverter : JsonConverter<Resource>
{
    public override void WriteJson(JsonWriter writer, Resource value, JsonSerializer serializer)
    {
        if (value == null)
        {
            writer.WriteNull();
            return;
        }
        
        writer.WriteStartObject();
        writer.WritePropertyName("$type");
        writer.WriteValue(value.GetType().Name);
        writer.WritePropertyName("path");
        writer.WriteValue(value.ResourcePath);
        writer.WriteEndObject();
    }
    
    public override Resource ReadJson(JsonReader reader, Type objectType, Resource existingValue, bool hasExistingValue, JsonSerializer serializer)
    {
        if (reader.TokenType == JsonToken.Null)
            return null;
            
        var obj = serializer.Deserialize<Dictionary<string, string>>(reader);
        var path = obj["path"];
        
        return GD.Load<Resource>(path);
    }
}
```

### ç‰ˆæœ¬åŒ–åºåˆ—åŒ–

```csharp
public class VersionedData
{
    public int Version { get; set; }
    public Dictionary<string, object> Data { get; set; } = new();
}

public class VersionedSerializer
{
    private readonly Dictionary<Type, int> _typeVersions = new();
    private readonly Dictionary<int, IDataMigration> _migrations = new();
    
    public void RegisterVersion<T>(int version)
    {
        _typeVersions[typeof(T)] = version;
    }
    
    public void RegisterMigration<T>(int fromVersion, int toVersion, IDataMigration<T> migration)
    {
        var key = GetMigrationKey(typeof(T), fromVersion, toVersion);
        _migrations[key] = migration;
    }
    
    public string Serialize<T>(T data)
    {
        var versioned = new VersionedData
        {
            Version = _typeVersions.GetValueOrDefault(typeof(T), 1),
            Data = new Dictionary<string, object>
            {
                ["type"] = typeof(T).Name,
                ["data"] = JsonConvert.SerializeObject(data)
            }
        };
        
        return JsonConvert.SerializeObject(versioned);
    }
    
    public T Deserialize<T>(string json)
    {
        var versioned = JsonConvert.DeserializeObject<VersionedData>(json);
        var currentVersion = _typeVersions.GetValueOrDefault(typeof(T), 1);
        
        // è¿ç§»æ•°æ®åˆ°å½“å‰ç‰ˆæœ¬
        var dataJson = MigrateData<T>(versioned.Data["data"] as string, versioned.Version, currentVersion);
        
        return JsonConvert.DeserializeObject<T>(dataJson);
    }
    
    private string MigrateData<T>(string dataJson, int fromVersion, int toVersion)
    {
        var currentData = dataJson;
        var currentVersion = fromVersion;
        
        while (currentVersion < toVersion)
        {
            var migrationKey = GetMigrationKey(typeof(T), currentVersion, currentVersion + 1);
            
            if (_migrations.TryGetValue(migrationKey, out var migration))
            {
                currentData = migration.Migrate(currentData);
                currentVersion++;
            }
            else
            {
                throw new InvalidOperationException($"No migration found from version {currentVersion} to {currentVersion + 1}");
            }
        }
        
        return currentData;
    }
    
    private int GetMigrationKey(Type type, int fromVersion, int toVersion)
    {
        return HashCode.Combine(type.Name, fromVersion, toVersion);
    }
}

public interface IDataMigration
{
    string Migrate(string data);
}

public interface IDataMigration<T> : IDataMigration
{
    T Migrate(T data);
}
```

## ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´çš„æ¸¸æˆæ•°æ®ç®¡ç†ç³»ç»Ÿ

```csharp
// 1. å®šä¹‰æ•°æ®æ¨¡å‹
public class GameProfile
{
    public string PlayerName { get; set; }
    public DateTime LastPlayed { get; set; }
    public int TotalPlayTime { get; set; }
    public List<Achievement> UnlockedAchievements { get; set; } = new();
}

public class GameSettings
{
    public float MasterVolume { get; set; } = 1.0f;
    public float MusicVolume { get; set; } = 0.8f;
    public float SFXVolume { get; set; } = 0.9f;
    public GraphicsSettings Graphics { get; set; } = new();
    public InputSettings Input { get; set; } = new();
}

// 2. åˆ›å»ºæ¸¸æˆç®¡ç†å™¨
[ContextAware]
[Log]
public partial class GameManager : Node, IController
{
    private GameAssetCatalog _assetCatalog;
    private GameDataManager _dataManager;
    private GameDataSerializer _serializer;
    
    protected override void OnInit()
    {
        // åˆå§‹åŒ–èµ„äº§ç›®å½•
        _assetCatalog = new GameAssetCatalog();
        _assetCatalog.Initialize();
        
        // åˆå§‹åŒ–å­˜å‚¨ç³»ç»Ÿ
        var rootStorage = new FileStorage("user://data/");
        var cachedStorage = new CachedStorage(rootStorage);
        _dataManager = new GameDataManager(cachedStorage);
        
        // åˆå§‹åŒ–åºåˆ—åŒ–å™¨
        _serializer = new GameDataSerializer();
        
        Logger.Info("Game manager initialized");
    }
    
    public void StartNewGame(string playerName)
    {
        Logger.Info($"Starting new game for player: {playerName}");
        
        // åˆ›å»ºæ–°çš„æ¸¸æˆæ¡£æ¡ˆ
        var profile = new GameProfile
        {
            PlayerName = playerName,
            LastPlayed = DateTime.Now,
            TotalPlayTime = 0
        };
        
        _dataManager.SavePlayerData("current", profile);
        
        // åŠ è½½åˆå§‹åœºæ™¯
        LoadInitialScene();
        
        Context.SendEvent(new NewGameStartedEvent { PlayerName = playerName });
    }
    
    public void LoadGame(int slotId)
    {
        Logger.Info($"Loading game from slot {slotId}");
        
        try
        {
            var saveData = _dataManager.LoadGame(slotId);
            if (saveData != null)
            {
                // æ¢å¤æ¸¸æˆçŠ¶æ€
                RestoreGameState(saveData);
                
                Context.SendEvent(new GameLoadedEvent { SlotId = slotId });
                Logger.Info("Game loaded successfully");
            }
            else
            {
                Logger.Warning($"No save data found in slot {slotId}");
                Context.SendEvent(new GameLoadFailedEvent { SlotId = slotId });
            }
        }
        catch (Exception ex)
        {
            Logger.Error($"Failed to load game: {ex.Message}");
            Context.SendEvent(new GameLoadFailedEvent { SlotId = slotId, Error = ex.Message });
        }
    }
    
    public void SaveGame(int slotId)
    {
        Logger.Info($"Saving game to slot {slotId}");
        
        try
        {
            var saveData = CreateSaveData();
            _dataManager.SaveGame(slotId, saveData);
            
            Context.SendEvent(new GameSavedEvent { SlotId = slotId });
            Logger.Info("Game saved successfully");
        }
        catch (Exception ex)
        {
            Logger.Error($"Failed to save game: {ex.Message}");
            Context.SendEvent(new GameSaveFailedEvent { SlotId = slotId, Error = ex.Message });
        }
    }
    
    private void LoadInitialScene()
    {
        var playerScene = _assetCatalog.GetScene<PackedScene>("Player");
        var player = playerScene.Instantiate<Player>();
        
        var gameWorldScene = _assetCatalog.GetScene<PackedScene>("GameWorld");
        var gameWorld = gameWorldScene.Instantiate<Control>();
        
        AddChild(gameWorld);
        gameWorld.AddChild(player);
    }
    
    private void RestoreGameState(SaveData saveData)
    {
        // æ¢å¤ç©å®¶ä½ç½®
        var playerScene = _assetCatalog.GetScene<PackedScene>("Player");
        var player = playerScene.Instantiate<Player>();
        player.Position = saveData.PlayerPosition;
        
        // æ¢å¤æ¸¸æˆä¸–ç•Œ
        var gameWorldScene = _assetCatalog.GetScene<PackedScene>("GameWorld");
        var gameWorld = gameWorldScene.Instantiate<Control>();
        
        AddChild(gameWorld);
        gameWorld.AddChild(player);
        
        // æ¢å¤å…¶ä»–æ¸¸æˆçŠ¶æ€
        Context.GetModel<PlayerModel>().Health.Value = saveData.PlayerHealth;
        Context.GetModel<GameModel>().CurrentLevel.Value = saveData.CurrentLevel;
        Context.GetModel<InventoryModel>().LoadFromData(saveData.Inventory);
    }
    
    private SaveData CreateSaveData()
    {
        var player = GetTree().CurrentScene.FindChild("Player");
        
        return new SaveData
        {
            PlayerPosition = player?.Position ?? Vector2.Zero,
            PlayerHealth = Context.GetModel<PlayerModel>().Health.Value,
            CurrentLevel = Context.GetModel<GameModel>().CurrentLevel.Value,
            Inventory = Context.GetModel<InventoryModel>().GetData(),
            Timestamp = DateTime.Now,
            Version = 1
        };
    }
}
```

### è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ

```csharp
public class AutoSaveSystem : AbstractSystem
{
    private Timer _autoSaveTimer;
    private int _currentSaveSlot;
    private float _autoSaveInterval;
    
    public AutoSaveSystem(float intervalMinutes = 5.0f)
    {
        _autoSaveInterval = intervalMinutes * 60.0f;
    }
    
    protected override void OnInit()
    {
        _autoSaveTimer = new Timer();
        _autoSaveTimer.WaitTime = _autoSaveInterval;
        _autoSaveTimer.Timeout += OnAutoSave;
        _autoSaveTimer.Autostart = true;
        
        AddChild(_autoSaveTimer);
        
        // ç›‘å¬é‡è¦äº‹ä»¶ï¼Œç«‹å³è‡ªåŠ¨ä¿å­˜
        this.RegisterEvent<PlayerDeathEvent>(OnImportantEvent);
        this.RegisterEvent<BossDefeatedEvent>(OnImportantEvent);
        this.RegisterEvent<LevelCompletedEvent>(OnImportantEvent);
        
        Logger.Info("Auto-save system initialized");
    }
    
    protected override void OnDestroy()
    {
        _autoSaveTimer?.Stop();
        
        // æœ€åä¸€æ¬¡è‡ªåŠ¨ä¿å­˜
        PerformAutoSave();
    }
    
    private void OnAutoSave()
    {
        PerformAutoSave();
        Logger.Debug("Periodic auto-save completed");
    }
    
    private void OnImportantEvent(IEvent e)
    {
        Logger.Info($"Important event {e.GetType().Name}, triggering auto-save");
        PerformAutoSave();
    }
    
    private void PerformAutoSave()
    {
        try
        {
            var saveData = CreateAutoSaveData();
            
            // ä¿å­˜åˆ°è‡ªåŠ¨å­˜æ¡£æ§½
            var storage = Context.GetUtility<IStorage>();
            storage.Write("autosave", saveData);
            storage.Write("autosave/timestamp", DateTime.Now);
            
            Logger.Debug("Auto-save completed successfully");
        }
        catch (Exception ex)
        {
            Logger.Error($"Auto-save failed: {ex.Message}");
        }
    }
    
    private SaveData CreateAutoSaveData()
    {
        return new SaveData
        {
            // ... åˆ›å»ºä¿å­˜æ•°æ®
        };
    }
}
```

## æœ€ä½³å®è·µ

### ğŸ—ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

#### 1. ç‰ˆæœ¬åŒ–æ•°æ®ç»“æ„

```csharp
// å¥½çš„åšæ³•ï¼šç‰ˆæœ¬åŒ–æ•°æ®æ¨¡å‹
[Serializable]
public class PlayerDataV2
{
    public int Version { get; set; } = 2;
    public string Name { get; set; }
    public int Health { get; set; }
    public int MaxHealth { get; set; } = 100; // V2 æ–°å¢
    public List<SkillData> Skills { get; set; } = new(); // V2 æ–°å¢
}

// é¿å…ï¼šæ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶
[Serializable]
public class PlayerData
{
    public string Name { get; set; }
    public int Health { get; set; }
    // æœªæ¥æ–°å¢å­—æ®µä¼šå¯¼è‡´å…¼å®¹æ€§é—®é¢˜
}
```

#### 2. æ•°æ®éªŒè¯

```csharp
public class PlayerData
{
    private string _name;
    
    public string Name
    {
        get => _name;
        set
        {
            if (string.IsNullOrWhiteSpace(value))
                throw new ArgumentException("Player name cannot be empty");
            _name = value;
        }
    }
    
    public int Health
    {
        get => _health;
        set => _health = Math.Max(0, value); // ç¡®ä¿ä¸ä¸ºè´Ÿæ•°
    }
    
    public void Validate()
    {
        if (string.IsNullOrWhiteSpace(Name))
            throw new ValidationException("Player name is required");
        
        if (Health < 0)
            throw new ValidationException("Health cannot be negative");
    }
}
```

### ğŸ’¾ å­˜å‚¨ç­–ç•¥

#### 1. åˆ†å±‚å­˜å‚¨å‘½å

```csharp
// å¥½çš„åšæ³•ï¼šæœ‰æ„ä¹‰çš„åˆ†å±‚ç»“æ„
var playerStorage = new ScopedStorage(rootStorage, "players");
var saveStorage = new ScopedStorage(rootStorage, "saves");
var settingsStorage = new ScopedStorage(rootStorage, "settings");
var tempStorage = new ScopedStorage(rootStorage, "temp");

// é¿å…çš„æ··ä¹±å‘½å
var storage1 = new ScopedStorage(rootStorage, "data1");
var storage2 = new ScopedStorage(rootStorage, "data2");
```

#### 2. å­˜å‚¨æ€§èƒ½ä¼˜åŒ–

```csharp
// å¥½çš„åšæ³•ï¼šæ‰¹é‡æ“ä½œå’Œç¼“å­˜
public class OptimizedDataManager
{
    private readonly IStorage _storage;
    private readonly Dictionary<string, object> _writeBuffer = new();
    
    public void QueueWrite<T>(string key, T data)
    {
        _writeBuffer[key] = data;
    }
    
    public async Task FlushWritesAsync()
    {
        var tasks = _writeBuffer.Select(kvp => _storage.WriteAsync(kvp.Key, kvp.Value));
        await Task.WhenAll(tasks);
        _writeBuffer.Clear();
    }
}

// é¿å…ï¼šé¢‘ç¹çš„å°å†™å…¥
public class InefficientDataManager
{
    public void UpdatePlayerStat(string stat, int value)
    {
        _storage.Write($"player/stats/{stat}", value); // æ¯æ¬¡éƒ½å†™å…¥ç£ç›˜
    }
}
```

### ğŸ”„ åºåˆ—åŒ–ä¼˜åŒ–

#### 1. é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ ¼å¼

```csharp
// å¥½çš„åšæ³•ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©æ ¼å¼
public class GameSerializer
{
    // JSONï¼šå¯è¯»æ€§å¥½ï¼Œè°ƒè¯•æ–¹ä¾¿
    public string SerializeForDebug(object data) => JsonConvert.SerializeObject(data, Formatting.Indented);
    
    // äºŒè¿›åˆ¶ï¼šä½“ç§¯å°ï¼Œæ€§èƒ½å¥½
    public byte[] SerializeForStorage(object data) => MessagePackSerializer.Serialize(data);
    
    // å‹ç¼©ï¼šå‡å°‘å­˜å‚¨ç©ºé—´
    public byte[] SerializeWithCompression(object data)
    {
        var json = JsonConvert.SerializeObject(data);
        return Compress(Encoding.UTF8.GetBytes(json));
    }
}
```

#### 2. è‡ªå®šä¹‰åºåˆ—åŒ–é€»è¾‘

```csharp
public class PlayerInventory
{
    public Dictionary<string, int> Items { get; set; } = new();
    
    [JsonIgnore] // æ’é™¤ä¸éœ€è¦åºåˆ—åŒ–çš„å±æ€§
    public int TotalWeight => Items.Sum(kvp => GetItemWeight(kvp.Key) * kvp.Value);
    
    [JsonProperty("total_items")] // è‡ªå®šä¹‰åºåˆ—åŒ–åç§°
    public int TotalItems => Items.Values.Sum();
    
    public bool ShouldSerializeItems() // æ¡ä»¶åºåˆ—åŒ–
    {
        return Items.Count > 0;
    }
    
    [OnDeserialized] // ååºåˆ—åŒ–åå¤„ç†
    private void OnDeserialized(StreamingContext context)
    {
        // åˆå§‹åŒ–é»˜è®¤å€¼æˆ–æ‰§è¡ŒéªŒè¯
        Items ??= new Dictionary<string, int>();
    }
}
```

### ğŸ­ æ¨¡å—è®¾è®¡æ¨¡å¼

#### 1. å•ä¸€èŒè´£æ¨¡å—

```csharp
// å¥½çš„åšæ³•ï¼šæ¨¡å—èŒè´£å•ä¸€
public class AudioModule : AbstractModule
{
    // åªè´Ÿè´£éŸ³é¢‘ç›¸å…³åŠŸèƒ½
}

public class SaveModule : AbstractModule
{
    // åªè´Ÿè´£å­˜æ¡£ç›¸å…³åŠŸèƒ½
}

// é¿å…ï¼šåŠŸèƒ½è¿‡äºåºå¤§
public class GameModule : AbstractModule
{
    // éŸ³é¢‘ã€å­˜æ¡£ã€UIã€è¾“å…¥å…¨éƒ¨æ··åœ¨ä¸€èµ·
}
```

#### 2. æ¨¡å—é—´é€šä¿¡

```csharp
public class SaveModule : AbstractModule
{
    public override void Install(IArchitecture architecture)
    {
        architecture.RegisterUtility(new SaveUtility());
    }
}

public class PlayerModule : AbstractModule
{
    public override void Install(IArchitecture architecture)
    {
        architecture.RegisterSystem(new PlayerSystem());
    }
    
    public override void OnPhase(ArchitecturePhase phase, IArchitecture architecture)
    {
        if (phase == ArchitecturePhase.Ready)
        {
            // é€šè¿‡äº‹ä»¶è¿›è¡Œæ¨¡å—é—´é€šä¿¡
            this.RegisterEvent<PlayerDeathEvent>(OnPlayerDeath);
        }
    }
    
    private void OnPlayerDeath(PlayerDeathEvent e)
    {
        // è§¦å‘ä¿å­˜æ¨¡å—çš„äº‹ä»¶
        Context.SendEvent(new RequestAutoSaveEvent { Reason = "Player Death" });
    }
}
```

## æ€§èƒ½ç‰¹æ€§

### ğŸ“Š å†…å­˜ç®¡ç†

- **ç¼“å­˜ç­–ç•¥**ï¼šå¤šå±‚ç¼“å­˜å‡å°‘ç£ç›˜ I/O
- **å»¶è¿ŸåŠ è½½**ï¼šæŒ‰éœ€åŠ è½½èµ„æºï¼Œå‡å°‘å†…å­˜å ç”¨
- **å¯¹è±¡æ± åŒ–**ï¼šé‡ç”¨å¯¹è±¡ï¼Œå‡å°‘ GC å‹åŠ›
- **å†…å­˜æ˜ å°„**ï¼šå¤§æ–‡ä»¶ä½¿ç”¨å†…å­˜æ˜ å°„æŠ€æœ¯

### âš¡ å­˜å‚¨æ€§èƒ½

```csharp
// æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹
public class StoragePerformanceTest
{
    // åŒæ­¥æ“ä½œï¼šç®€å•ç›´æ¥
    public void SyncWrite(IStorage storage, string key, object data)
    {
        storage.Write(key, data); // ~1-5ms
    }
    
    // å¼‚æ­¥æ“ä½œï¼šéé˜»å¡
    public async Task AsyncWrite(IStorage storage, string key, object data)
    {
        await storage.WriteAsync(key, data); // ~0.1-1ms (ä¸é˜»å¡ä¸»çº¿ç¨‹)
    }
    
    // æ‰¹é‡æ“ä½œï¼šé«˜ååé‡
    public async Task BatchWrite(IStorage storage, Dictionary<string, object> data)
    {
        var tasks = data.Select(kvp => storage.WriteAsync(kvp.Key, kvp.Value));
        await Task.WhenAll(tasks); // ~10-50ms for 100 items
    }
}
```

### ğŸ”„ åºåˆ—åŒ–ä¼˜åŒ–

- **æ ¼å¼é€‰æ‹©**ï¼šJSONï¼ˆå¯è¯»æ€§ï¼‰vs äºŒè¿›åˆ¶ï¼ˆæ€§èƒ½ï¼‰
- **å‹ç¼©æŠ€æœ¯**ï¼šå‡å°‘å­˜å‚¨ç©ºé—´å’Œç½‘ç»œä¼ è¾“
- **å¢é‡åºåˆ—åŒ–**ï¼šåªåºåˆ—åŒ–å˜åŒ–çš„éƒ¨åˆ†
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå‘åå…¼å®¹çš„æ•°æ®è¿ç§»

---

## ä¾èµ–å…³ç³»

```mermaid
graph TD
    A[GFramework.Game] --> B[GFramework.Core]
    A --> C[GFramework.Core.Abstractions]
    A --> D[Newtonsoft.Json]
    A --> E[System.Text.Json]
```

## ç‰ˆæœ¬å…¼å®¹æ€§

- **.NET**: 6.0+
- **Newtonsoft.Json**: 13.0.3+
- **GFramework.Core**: ä¸ Core æ¨¡å—ç‰ˆæœ¬ä¿æŒåŒæ­¥
---