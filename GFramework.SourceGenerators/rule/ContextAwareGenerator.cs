using System;
using System.Text;
using GFramework.SourceGenerators.Abstractions.rule;
using GFramework.SourceGenerators.Common.constants;
using GFramework.SourceGenerators.Common.generator;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;

namespace GFramework.SourceGenerators.rule;

[Generator]
public sealed class ContextAwareGenerator : AttributeClassGeneratorBase
{
    /// <summary>
    ///     使用强类型 Attribute，替代字符串
    /// </summary>
    protected override Type AttributeType => typeof(ContextAwareAttribute);

    /// <summary>
    ///     仅用于 Syntax 粗筛选
    /// </summary>
    protected override string AttributeShortNameWithoutSuffix => "ContextAware";

    /// <summary>
    ///     额外语义校验：必须实现 IContextAware
    /// </summary>
    protected override bool ValidateSymbol(
        SourceProductionContext context,
        ClassDeclarationSyntax syntax,
        INamedTypeSymbol symbol,
        AttributeData attr)
    {
        return true;
    }

    /// <summary>
    ///     生成源码
    /// </summary>
    protected override string Generate(
        INamedTypeSymbol symbol,
        AttributeData attr)
    {
        var ns = symbol.ContainingNamespace.IsGlobalNamespace
            ? null
            : symbol.ContainingNamespace.ToDisplayString();

        var sb = new StringBuilder();
        sb.AppendLine("// <auto-generated/>");
        sb.AppendLine("#nullable enable");
        sb.AppendLine();

        if (ns is not null)
        {
            sb.AppendLine($"namespace {ns};");
            sb.AppendLine();
        }

        sb.AppendLine($"partial class {symbol.Name}");
        sb.AppendLine("{");

        // 属性
        sb.AppendLine("    /// <summary>");
        sb.AppendLine("    /// 自动注入的架构上下文");
        sb.AppendLine("    /// </summary>");
        sb.AppendLine(
            $"    protected {PathContests.CoreAbstractionsNamespace}.architecture.IArchitectureContext Context {{ get; private set; }} = null!;");
        sb.AppendLine();

        // 方法
        sb.AppendLine(
            $"    void {PathContests.CoreAbstractionsNamespace}.rule.IContextAware.SetContext(");
        sb.AppendLine(
            $"        {PathContests.CoreAbstractionsNamespace}.architecture.IArchitectureContext context)");
        sb.AppendLine("    {");
        sb.AppendLine("        Context = context;");
        sb.AppendLine("    }");

        sb.AppendLine("}");

        return sb.ToString().TrimEnd();
    }


    /// <summary>
    ///     自定义生成文件名
    /// </summary>
    protected override string GetHintName(INamedTypeSymbol symbol)
    {
        // 包含命名空间和生成器类名路径
        return
            $"{symbol.Name}.ContextAware.g.cs";
    }
}